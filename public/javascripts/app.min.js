var mapApp=angular.module("map-app",["ngRoute","ngResource"]),mapApp=angular.module("map-app",["ngRoute","ngResource"]);mapApp.factory("AlertService",["$rootScope",function(e){return e.alert={},{addAlert:function(t,n){e.alert={type:t,message:n}},closeArert:function(){e.alert={}}}}]),mapApp.factory("ItineraryService",function(){function e(e){for(var t=r.length,n=0;t>n;n++)if(e===r[n].id)return!1;return!0}function t(e){if(!e&&"number"!=typeof e)throw new Error("The specified key is wrong. Please try again");return!1}var n={},r=[],o=[{type:"Car",mode:"fastest;car",combineChange:""},{type:"Public transportation",mode:"fastest;publicTransport",combineChange:!0},{type:"On feet",mode:"fastest;pedestrian",combineChange:""}],i=o[0],a="";return{addWaypointToItinerary:function(t){var o={place:t.Location.Address.Label,id:t.Location.LocationId,position:{lat:t.Location.DisplayPosition.Latitude,lon:t.Location.DisplayPosition.Longitude}};if(!e(o.id))throw new Error("This place is already added to your list!");n=o,r.push(o)},changeOrderOfWaypointsInItinerary:function(e,n){if(!t(n)){var o=r[n];if("up"===e){if(0===n)return r;r[n]=r[n-1],r[n-1]=o}else if("down"===e){if(n===r.length-1)return r;r[n]=r[n+1],r[n+1]=o}}return r},removeWaypointFromItinerary:function(e){return t(e)?void 0:(r.splice(e,1),r)},getItinerary:function(){return r},setTransportationMode:function(e){i=e},getTransportationMode:function(){return i},getTransportationModes:function(){return o},getSummaryText:function(){return a},setSummaryText:function(e){a=e}}}),mapApp.factory("MapService",function(){var e=null,t=new H.service.Platform({app_id:"wLWuweij9RTP8EtgUKYc",app_code:"s4gqVLTvBeEDQMiSECS8WQ",useCIT:!0,useHTTPS:!1}),n=t.createDefaultLayers();return{initializeMap:function(){var t=document.getElementById("map");t.innerHTML="",e=new H.Map(t,n.normal.map,{center:{lat:52,lng:5},zoom:5}),new H.mapevents.Behavior(new H.mapevents.MapEvents(e)),H.ui.UI.createDefault(e,n)},drawRouteInMap:function(t){var n,r,o,i;if(!t.response.route)throw new Error("An unexpected error happened. Please try again!");n=t.response.route[0],r=n.shape,o=new H.geo.Strip,r.forEach(function(e){var t=e.split(",");o.pushLatLngAlt(t[0],t[1])}),i=[];for(var a=0;a<n.waypoint.length;a++)i[a]=n.waypoint[a].mappedPosition;var s=new H.map.Polyline(o,{style:{strokeColor:"blue",lineWidth:4}});this.initializeMap(),e.addObject(s);for(var a=0;a<i.length;a++)e.addObject(new H.map.Marker({lat:i[a].latitude,lng:i[a].longitude}));e.setViewBounds(s.getBounds())}}}),mapApp.factory("RouteService",["$resource",function(e){return e("https://route.cit.api.here.com/routing/7.2/calculateroute.json?:waypoints&mode=:mode&combineChange=:combineChange&app_id=wLWuweij9RTP8EtgUKYc&app_code=s4gqVLTvBeEDQMiSECS8WQ&routeattributes=shape",{mode:encodeURIComponent("@mode"),combineChange:encodeURIComponent("@combineChange")})}]),mapApp.factory("SearchService",["$resource",function(e){return e("https://geocoder.cit.api.here.com/6.2/geocode.json?searchtext=:searchText&app_id=wLWuweij9RTP8EtgUKYc&app_code=s4gqVLTvBeEDQMiSECS8WQ&gen=100")}]),mapApp.controller("ListController",["$scope","$sce","ItineraryService",function(e,t,n){e.indexOfSelectedRow=null,e.itineraryList=[],e.transportationModes=n.getTransportationModes(),e.currentTransportationMode=n.getTransportationMode(),e.summaryText="",e.$watch("currentTransportationMode",function(e,t){e.mode!==t.mode&&n.setTransportationMode(e)},!0),e.$watchCollection(function(){return n.getItinerary()},function(t,n){e.itineraryList=t}),e.$watch(function(){return n.getSummaryText()},function(n,r){n!==r&&(e.summaryText=t.trustAsHtml(n))}),e.selectRow=function(t){t||"number"==typeof t||(t=0),e.indexOfSelectedRow=t},e.moveRowUp=function(){e.itineraryList=n.changeOrderOfWaypointsInItinerary("up",e.indexOfSelectedRow),e.indexOfSelectedRow--},e.moveRowDown=function(){e.itineraryList=n.changeOrderOfWaypointsInItinerary("down",e.indexOfSelectedRow),e.indexOfSelectedRow++},e.removeRow=function(){e.itineraryList=n.removeWaypointFromItinerary(e.indexOfSelectedRow)}}]),mapApp.controller("MapController",["$scope","RouteService","ItineraryService","MapService",function(e,t,n,r){function o(e,o){var a=i(e);t.get({mode:o.mode,waypoints:a,combineChange:o.combineChange}).$promise.then(function(e){n.setSummaryText(e.response.route[0].summary.text),r.drawRouteInMap(e)})["catch"](function(e){if("NGEO_ERROR_GRAPH_DISCONNECTED"===e.data.additionalData[0].value)throw n.setSummaryText(""),r.initializeMap(),new Error("We found no route for the selected transportation mode!");throw new Error("An unexpected error happened. Please try again!")})}function i(){for(var e=n.getItinerary(),t=e.length,r="",o=0;t>o;o++)r+="waypoint"+o+"="+e[o].position.lat+","+e[o].position.lon+(o!=e.length-1?"&":"");return r}function a(e){return e.length>=2}r.initializeMap(),e.$watchCollection(function(){return n.getItinerary()},function(e,t){e!==t&&(a(e)?o(n.getItinerary(),n.getTransportationMode()):r.initializeMap())}),e.$watch(function(){return n.getTransportationMode()},function(e,t){e.mode!==t.mode&&o(n.getItinerary(),e)},!0)}]),mapApp.controller("SearchController",["$scope","SearchService","ItineraryService",function(e,t,n){function r(e){return 1===e.length}function o(e){return e}e.searchResults=[],e.isResultsListVisible=!1,e.searchText="",e.toggleResultsList=function(){e.isResultsListVisible=!e.isResultsListVisible},e.search=function(){t.get({searchText:e.searchText}).$promise.then(function(t){var i=t.Response.View[0];if(!o(i))throw new Error("No matching results were returned!");var a=i.Result;r(a)?(e.isResultsListVisible&&e.toggleResultsList(),n.addWaypointToItinerary(a[0])):(e.searchResults=a,e.toggleResultsList())})["catch"](function(e){throw new Error(e.message)})},e.selectRow=function(t){n.addWaypointToItinerary(e.searchResults[t]),e.searchResults=[],e.toggleResultsList()}}]),mapApp.factory("$exceptionHandler",["$injector",function(e){return function(t,n){console.log(t),e.get("AlertService").addAlert("danger",t.message)}}]),mapApp.factory("AlertService",["$rootScope",function(e){return e.alert={},{addAlert:function(t,n){e.alert={type:t,message:n}},closeArert:function(){e.alert={}}}}]),mapApp.factory("ItineraryService",function(){function e(e){for(var t=r.length,n=0;t>n;n++)if(e===r[n].id)return!1;return!0}function t(e){if(!e&&"number"!=typeof e)throw new Error("The specified key is wrong. Please try again");return!1}var n={},r=[],o=[{type:"Car",mode:"fastest;car",combineChange:""},{type:"Public transportation",mode:"fastest;publicTransport",combineChange:!0},{type:"On feet",mode:"fastest;pedestrian",combineChange:""}],i=o[0],a="";return{addWaypointToItinerary:function(t){var o={place:t.Location.Address.Label,id:t.Location.LocationId,position:{lat:t.Location.DisplayPosition.Latitude,lon:t.Location.DisplayPosition.Longitude}};if(!e(o.id))throw new Error("This place is already added to your list!");n=o,r.push(o)},changeOrderOfWaypointsInItinerary:function(e,n){if(!t(n)){var o=r[n];if("up"===e){if(0===n)return r;r[n]=r[n-1],r[n-1]=o}else if("down"===e){if(n===r.length-1)return r;r[n]=r[n+1],r[n+1]=o}}return r},removeWaypointFromItinerary:function(e){return t(e)?void 0:(r.splice(e,1),r)},getItinerary:function(){return r},setTransportationMode:function(e){i=e},getTransportationMode:function(){return i},getTransportationModes:function(){return o},getSummaryText:function(){return a},setSummaryText:function(e){a=e}}}),mapApp.factory("MapService",function(){var e=null,t=new H.service.Platform({app_id:"wLWuweij9RTP8EtgUKYc",app_code:"s4gqVLTvBeEDQMiSECS8WQ",useCIT:!0,useHTTPS:!1}),n=t.createDefaultLayers();return{initializeMap:function(){var t=document.getElementById("map");t.innerHTML="",e=new H.Map(t,n.normal.map,{center:{lat:52,lng:5},zoom:5});new H.mapevents.Behavior(new H.mapevents.MapEvents(e)),H.ui.UI.createDefault(e,n)},drawRouteInMap:function(t){var n,r,o,i;if(!t.response.route)throw new Error("An unexpected error happened. Please try again!");n=t.response.route[0],r=n.shape,o=new H.geo.Strip,r.forEach(function(e){var t=e.split(",");o.pushLatLngAlt(t[0],t[1])}),i=[];for(var a=0;a<n.waypoint.length;a++)i[a]=n.waypoint[a].mappedPosition;var s=new H.map.Polyline(o,{style:{strokeColor:"blue",lineWidth:4}});this.initializeMap(),e.addObject(s);for(var a=0;a<i.length;a++)e.addObject(new H.map.Marker({lat:i[a].latitude,lng:i[a].longitude}));e.setViewBounds(s.getBounds())}}}),mapApp.factory("RouteService",["$resource",function(e){return e("https://route.cit.api.here.com/routing/7.2/calculateroute.json?:waypoints&mode=:mode&combineChange=:combineChange&app_id=wLWuweij9RTP8EtgUKYc&app_code=s4gqVLTvBeEDQMiSECS8WQ&routeattributes=shape",{mode:encodeURIComponent("@mode"),combineChange:encodeURIComponent("@combineChange")})}]),mapApp.factory("SearchService",["$resource",function(e){return e("https://geocoder.cit.api.here.com/6.2/geocode.json?searchtext=:searchText&app_id=wLWuweij9RTP8EtgUKYc&app_code=s4gqVLTvBeEDQMiSECS8WQ&gen=100")}]),mapApp.controller("ListController",["$scope","$sce","ItineraryService",function(e,t,n){e.indexOfSelectedRow=null,e.itineraryList=[],e.transportationModes=n.getTransportationModes(),e.currentTransportationMode=n.getTransportationMode(),e.summaryText="",e.$watch("currentTransportationMode",function(e,t){e.mode!==t.mode&&n.setTransportationMode(e)},!0),e.$watchCollection(function(){return n.getItinerary()},function(t,n){e.itineraryList=t}),e.$watch(function(){return n.getSummaryText()},function(n,r){n!==r&&(e.summaryText=t.trustAsHtml(n))}),e.selectRow=function(t){t||"number"==typeof t||(t=0),e.indexOfSelectedRow=t},e.moveRowUp=function(){e.itineraryList=n.changeOrderOfWaypointsInItinerary("up",e.indexOfSelectedRow),e.indexOfSelectedRow--},e.moveRowDown=function(){e.itineraryList=n.changeOrderOfWaypointsInItinerary("down",e.indexOfSelectedRow),e.indexOfSelectedRow++},e.removeRow=function(){e.itineraryList=n.removeWaypointFromItinerary(e.indexOfSelectedRow)}}]),mapApp.controller("MapController",["$scope","RouteService","ItineraryService","MapService",function(e,t,n,r){function o(e,o){var a=i(e);t.get({mode:o.mode,waypoints:a,combineChange:o.combineChange}).$promise.then(function(e){n.setSummaryText(e.response.route[0].summary.text),r.drawRouteInMap(e)})["catch"](function(e){if("NGEO_ERROR_GRAPH_DISCONNECTED"===e.data.additionalData[0].value)throw n.setSummaryText(""),r.initializeMap(),new Error("We found no route for the selected transportation mode!");throw new Error("An unexpected error happened. Please try again!")})}function i(){for(var e=n.getItinerary(),t=e.length,r="",o=0;t>o;o++)r+="waypoint"+o+"="+e[o].position.lat+","+e[o].position.lon+(o!=e.length-1?"&":"");return r}function a(e){return e.length>=2}r.initializeMap(),e.$watchCollection(function(){return n.getItinerary()},function(e,t){e!==t&&(a(e)?o(n.getItinerary(),n.getTransportationMode()):r.initializeMap())}),e.$watch(function(){return n.getTransportationMode()},function(e,t){e.mode!==t.mode&&o(n.getItinerary(),e)},!0)}]),mapApp.controller("SearchController",["$scope","SearchService","ItineraryService",function(e,t,n){function r(e){return 1===e.length}function o(e){return e}e.searchResults=[],e.isResultsListVisible=!1,e.searchText="",e.toggleResultsList=function(){e.isResultsListVisible=!e.isResultsListVisible},e.search=function(){t.get({searchText:e.searchText}).$promise.then(function(t){var i=t.Response.View[0];if(!o(i))throw new Error("No matching results were returned!");var a=i.Result;r(a)?(e.isResultsListVisible&&e.toggleResultsList(),n.addWaypointToItinerary(a[0])):(e.searchResults=a,e.toggleResultsList())})["catch"](function(e){throw new Error(e.message)})},e.selectRow=function(t){n.addWaypointToItinerary(e.searchResults[t]),e.searchResults=[],e.toggleResultsList()}}]),mapApp.factory("$exceptionHandler",["$injector",function(e){return function(t,n){console.log(t),e.get("AlertService").addAlert("danger",t.message)}}]);